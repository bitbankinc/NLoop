## Manual testing with docker-compose

### Service dependencies graph.

![Test dependency graph](../../images/test_deps.png)

### How-to

Note that this requires .NET SDK with compatible version installed.

```sh
# --- prepare dependent services ---
cd tests/NLoop.Server.Tests

docker-compose up -d # Start dependencies such as bitcoind and lnd

# regtest blockchain is too empty that clients fails to estimate the fee.
# So fill in some dummy tx's and funds by this command, it may take a while to complete.
# This is necessary only for performing an actual swap and not for running the server itself.
./cliutils/prepare_tx_for_fee.sh

# you can also use these scripts for invoking RPC methods for bitcoind, lnd.
./docker-bitcoin-cli.sh getblockchaininfo
./docker-litecoin-cli.sh getblockchaininfo
./docker-lncli-user.sh getinfo
./docker-lncli-server_ltc.sh getinfo
# Some interactive operation (e.g. lnd's `payinvoice`) may require you to execute it with the pseudo-tty.
# in that case do not use these scripts and run `docker-compose exec` without `-T` option

cd ../..
# --- ---

# --- start running nloopd ---

# You must run this as a same user with a `docker-compose`.
# Since it reads files in `tests/NLoop.Server.Tests/data` generated by the docker-compose command above.
./scripts/start_with_local_docker.sh

# --- ---

# Get general information about NLoop.
curl http://localhost:5000/v1/info

```

You can access http://localhost:2113 for EventStoreDB admin ui to check the current state of the db.

To reset the state, you can just run the following commands after stopping the docker-compose.

```sh
cd tests/NLoop.Server.Tests
rm -rf data
git checkout -- data
```

For tests those which have a trait "Docker=On", you should first run `docker-compose up` in the background,
These tests are too heavy that it won't run in the CI, but it is necessary to assure the health of the app.

### testing the behaviour for running nloopd as a c-lightning plugin.

You must first prepare single-file-compiled `nloopd` and incorporate it into clightning docker image

```bash
# ... move to solution root

# this outputs `nloopd` into `tests/NLoop.Server.Tests/Dockerfiles/publish`
./scripts/build_singlebinary_debug.sh 

# build the new clightning image containing nloopd in it.
docker-compose build clightning
```

